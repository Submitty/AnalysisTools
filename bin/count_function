#!/usr/bin/env python3.4

"""
Determine whether a file contains a function call to the given name.
"""

import sys
import os
import argparse

DIR = os.path.dirname(os.path.abspath(__file__))

sys.path.append(os.path.join(DIR, ".."))

import lang.parser

ARGPARSER = argparse.ArgumentParser(\
        description="Determine whether a file contains a function call to the given name.")
ARGPARSER.add_argument("function")
ARGPARSER.add_argument("file", nargs="*", default=None)
ARGPARSER.add_argument("-l", "--lang", type=str)
ARGS = ARGPARSER.parse_args()

SUM = 0

for file in ARGS.file:
    EXT = os.path.splitext(file)[1][1:]

    DATA = ""
    with open(file, "r", encoding="ISO-8859-1") as f:
        for line in f:
            DATA += line

    PARSER = None

    if ARGS.lang:
        LANG = ARGS.lang
    else:
        if EXT in ["c", "cpp", "cc", "C", "h", "hpp", "H"]:
            LANG = "c"
        elif EXT in ["py"]:
            LANG = "python3"

    if LANG == "c":
        PARSER = lang.parser.c
    elif LANG == "python3":
        PARSER = lang.parser.python
    elif LANG == "python2":
        PARSER = lang.parser.python2

    if PARSER:
        SUM += len([n for n in list(lang.parser.walk(PARSER(DATA)))
                    if n.name == "call"
                    and n.children[0].name == "name"
                    and n.children[0].data == ARGS.function])
    else:
        print("Error: invalid filetype")
        sys.exit(1)

print(SUM)

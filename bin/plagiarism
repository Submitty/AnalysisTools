#!/usr/bin/env python3

"""
Run plagiarism detection system.
"""

import argparse
import json
import subprocess

ARGPARSER = argparse.ArgumentParser(\
        description="Run plagiarism detection system.")
ARGPARSER.add_argument("filetype")
ARGPARSER.add_argument("directory")
ARGPARSER.add_argument("-c", "--config", type=int)
ARGS = ARGPARSER.parse_args()

with open(ARGS.config if ARGS.config else "config/plagiarism.json") as f:
    CONFIG = json.load(f)

if CONFIG[ARGS.filetype]:
    WALK_FLAGS = ["-u",
                  str(CONFIG[ARGS.filetype]["UpperBound"]),
                  "-l",
                  str(CONFIG[ARGS.filetype]["LowerBound"])]
else:
    WALK_FLAGS = []

TIMESTAMP = subprocess.check_output(["./bin/walk"]
                                    + WALK_FLAGS
                                    + [ARGS.filetype, ARGS.directory])\
                                            .decode("utf-8").strip()

GENPAIRS = subprocess.Popen(["./bin/genpairs", TIMESTAMP],
                            stdout=subprocess.PIPE)
COMPARE_FINGERPRINTS = subprocess.Popen(["./bin/compare_fingerprints",
                                         TIMESTAMP],
                                        stdin=GENPAIRS.stdout,
                                        stdout=subprocess.PIPE)
SORT = subprocess.Popen(["sort", "-nr"],
                        stdin=COMPARE_FINGERPRINTS.stdout)

SORT.wait()

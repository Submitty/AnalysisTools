#!/usr/bin/python

import argparse
import json
import subprocess

parser = argparse.ArgumentParser(description="Run plagiarism detection system")
parser.add_argument("filetype")
parser.add_argument("directory")
parser.add_argument("-c", "--config", type=int)
args = parser.parse_args()

with open(args.config if args.config else "config/plagiarism.json") as f:
    config = json.load(f)

timestamp = subprocess.check_output(["./bin/walk"] +
        (["-u", str(config[args.filetype]["UpperBound"]),
            "-l", str(config[args.filetype]["LowerBound"])] if config[args.filetype] else []) +
        [args.filetype, args.directory]).decode("utf-8").strip()

genpairs = subprocess.Popen(["./bin/genpairs", timestamp],
        stdout=subprocess.PIPE)
compare_fingerprints = subprocess.Popen(["./bin/compare_fingerprints", timestamp],
        stdin=genpairs.stdout, stdout=subprocess.PIPE)
sort = subprocess.Popen(["sort", "-nr"],
        stdin=compare_fingerprints.stdout)
